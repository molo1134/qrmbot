#!/usr/bin/perl
# randomizer

# 2-clause BSD license.
# Copyright (c) 2020 molo1134@github. All rights reserved.

use strict;
use utf8;
use Encode qw(decode);
use feature 'unicode_strings';
binmode(STDOUT, ":utf8");

use File::Basename;
use Cwd 'realpath';
use lib dirname(realpath(__FILE__));
use Util;
use Colors;

# disable "experimental" warning on smart match operator use
no if $] >= 5.018, warnings => "experimental::smartmatch";

@ARGV = map { decode "utf-8", $_ } @ARGV;

# eggdrop doesn't split args on spaces
@ARGV=split(' ', join(' ',@ARGV));

my $a = 1;
my $x = 100;
my @list = ();

my @carddeck = (
      blackOnWhite("2♣"), blackOnWhite("3♣"), blackOnWhite("4♣"),
      blackOnWhite("5♣"), blackOnWhite("6♣"), blackOnWhite("7♣"),
      blackOnWhite("8♣"), blackOnWhite("9♣"), blackOnWhite("10♣"),
      blackOnWhite("J♣"), blackOnWhite("Q♣"), blackOnWhite("K♣"),
      blackOnWhite("A♣"),
      redOnWhite("2♦"), redOnWhite("3♦"), redOnWhite("4♦"), redOnWhite("5♦"),
      redOnWhite("6♦"), redOnWhite("7♦"), redOnWhite("8♦"), redOnWhite("9♦"),
      redOnWhite("10♦"), redOnWhite("J♦"), redOnWhite("Q♦"), redOnWhite("K♦"),
      redOnWhite("A♦"),
      redOnWhite("2♥"), redOnWhite("3♥"), redOnWhite("4♥"), redOnWhite("5♥"),
      redOnWhite("6♥"), redOnWhite("7♥"), redOnWhite("8♥"), redOnWhite("9♥"),
      redOnWhite("10♥"), redOnWhite("J♥"), redOnWhite("Q♥"), redOnWhite("K♥"),
      redOnWhite("A♥"),
      blackOnWhite("2♠"), blackOnWhite("3♠"), blackOnWhite("4♠"),
      blackOnWhite("5♠"), blackOnWhite("6♠"), blackOnWhite("7♠"),
      blackOnWhite("8♠"), blackOnWhite("9♠"), blackOnWhite("10♠"),
      blackOnWhite("J♠"), blackOnWhite("Q♠"), blackOnWhite("K♠"),
      blackOnWhite("A♠"),
    );
my @wheel = (
      green("00"),
      red("27"),
      blackOnWhite("10"),
      red("25"),
      blackOnWhite("29"),
      red("12"),
      blackOnWhite("8"),
      red("19"),
      blackOnWhite("31"),
      red("18"),
      blackOnWhite("6"),
      red("21"),
      blackOnWhite("33"),
      red("16"),
      blackOnWhite("4"),
      red("23"),
      blackOnWhite("35"),
      red("14"),
      blackOnWhite("2"),
      green("0"), # green
      blackOnWhite("28"),
      red("9"),
      blackOnWhite("26"),
      red("30"),
      blackOnWhite("11"),
      red("7"),
      blackOnWhite("20"),
      red("32"),
      blackOnWhite("17"),
      red("5"),
      blackOnWhite("22"),
      red("34"),
      blackOnWhite("15"),
      red("3"),
      blackOnWhite("21"),
      red("36"),
      blackOnWhite("13"),
      red("1"));

# ── Orb legendary responses ───────────────────────────────────────────────────
# Each entry is a sub($is_yes) returning a list of formatted output lines.
my @orb_legendary = (

  # ═══ BLUE TIER — Cosmic Wonder ═══════════════════════════════════════════

  # The Ancient Prophecy
  sub { my $y = shift;
    (italic(grey("the orb shudders...")),
     italic(grey("dust of a thousand ages rises from its surface...")),
     bold(lightblue("it glows \x{2014} slowly, deeply \x{2014} BLUE")),
     lightblue('"In the age before memory, this question was carved into the bones of the earth."'),
     $y ? bold(green('"The answer has always been: YES."'))
        : bold(red('"The answer has always been: NO."'))) },

  # The Reluctant Oracle
  sub { my $y = shift;
    (italic(grey("the orb goes dark")),
     italic(grey("...")),
     italic(grey("it fights it. you can tell. it doesn't want to show you this.")),
     bold(lightblue("the blue light wins.")),
     lightblue('"...Fine. You deserve to know. But do not ask again."'),
     $y ? bold(green('"YES."')) : bold(red('"NO. And I mean it."'))) },

  # The Cosmic Horror
  sub { my $y = shift;
    (italic(grey("the orb reaches out... further than it usually does...")),
     italic(grey("something reached back")),
     bold(lightblue("it glows blue but the light feels wrong")),
     $y ? bold(green('"I looked. I saw. The answer is YES."'))
        : bold(red('"I looked. I saw. The answer is NO."')),
     lightblue('"Please do not ask what else I saw."')) },

  # The Joyful Burst
  sub { my $y = shift;
    (bold(lightblue("THE ORB WAKES UP")),
     bold(lightblue("IT HAS BEEN WAITING FOR THIS EXACT QUESTION")),
     bold(lightblue("BLUE. SO MUCH BLUE. GLORIOUS BLUE.")),
     lightblue('"OH THIS ONE. THIS IS A GOOD ONE."'),
     $y ? bold(green('"YES. YES YES YES."'))
        : bold(red('"No. But asked so beautifully."'))) },

  # The Ominous Agreement
  sub { my $y = shift;
    (italic(grey("the orb is very still")),
     bold(lightblue("the orb glows blue \x{2014} not warm. cold. certain.")),
     $y ? bold(green('"...Yes."')) : bold(red('"...No."')),
     lightblue('"I just want you to sit with that for a moment."')) },

  # The Weary God
  sub { my $y = shift;
    (italic(grey("the orb has seen empires. it has seen them fall.")),
     italic(grey("it glows blue, tired blue, the blue of something very old")),
     $y ? lightblue('"You want to know if YES?"') : lightblue('"You want to know if NO?"'),
     $y ? bold(green('"Sure. Fine. It\'s YES."')) : bold(red('"No. As it always was."')),
     lightblue('"The orb will now rest."')) },

  # The Hype Man
  sub { my $y = shift;
    (bold(lightblue("YOOOO")),
     bold(lightblue("THE ORB IS GLOWING BLUE ARE YOU SEEING THIS")),
     bold(lightblue("THIS IS A LEGENDARY PROPHECY CHAT")),
     lightblue('"Okay okay okay. The answer?"'),
     $y ? bold(green('"IT\'S YES."')) : bold(red('"It\'s no. But still legendary tho."'))) },

  # ═══ RED TIER — Cursed Doom ═══════════════════════════════════════════════

  # The Warning
  sub { my $y = shift;
    (italic(grey("the orb flickers")),
     italic(grey("something is wrong")),
     bold(red("it glows RED")),
     darkRed('"This question should not have been asked."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"The orb will not say more. For your sake."')) },

  # The Curse
  sub { my $y = shift;
    (italic(grey("the orb goes cold")),
     italic(grey("the red comes from somewhere deep. somewhere bad.")),
     darkRed('"Seven people asked this question before you."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"You are the eighth."')) },

  # The Reluctant Truth
  sub { my $y = shift;
    (italic(grey("the orb tries to show you blue")),
     italic(grey("it cannot")),
     bold(red("RED. it's RED. it's always been RED for this one.")),
     darkRed('"I tried to protect you from this answer."'),
     $y ? bold(green('"YES. God help you, yes."')) : bold(red('"NO."'))) },

  # The Void Stares Back
  sub { my $y = shift;
    (italic(grey("the orb reaches out to find your answer")),
     italic(grey("something on the other side noticed")),
     bold(red("RED. wrong. all wrong.")),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"It knows you asked."')) },

  # The Omen
  sub { my $y = shift;
    (italic(grey("the orb begins to spin \x{2014} slowly \x{2014} without being touched")),
     italic(grey("it stops")),
     bold(red("RED")),
     darkRed('"The birds knew. They left this morning."'),
     $y ? bold(green('"The answer is YES."')) : bold(red('"The answer is NO."')),
     darkRed('"You\'ll understand later."')) },

  # The Disappointed Elder
  sub { my $y = shift;
    (italic(grey("the orb has seen this before")),
     italic(grey("it glows red, slow and heavy, like a dying star")),
     darkRed('"Oh, child."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"The orb will light a candle for you."')) },

  # The Understated Doom
  sub { my $y = shift;
    (bold(red("red")),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"Anyway."')) },

  # The Regret
  sub { my $y = shift;
    (italic(grey("the orb glows red and does not stop")),
     italic(grey("it's been a long time since it glowed red this long")),
     darkRed('"You asked. That means something."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkRed('"The orb is sorry. It really is."')) },

  # ═══ ELECTRIC TIER — Chaotic Gremlin Energy ═══════════════════════════════

  # The Surge
  sub { my $y = shift;
    (bold(yellow("the orb CRACKS")),
     italic(grey("sparks. actual sparks.")),
     italic(grey("it's doing it again")),
     $y ? bold(green('"THE ANSWER IS YES"')) : bold(red('"THE ANSWER IS NO"')),
     bold(yellow('"THE ORB DOES NOT APOLOGIZE FOR THE SPARKS"'))) },

  # The Short Circuit
  sub { my $y = shift;
    (italic(grey("the orb flickers \x{2014} on \x{2014} off \x{2014} on \x{2014} off \x{2014}")),
     bold(yellow("zzzt")),
     bold(yellow("zzzzZZZZT")),
     italic(grey("........okay it's fine")),
     $y ? bold(green('"Yes."')) : bold(red('"No."')),
     yellow('"The orb is fine."')) },

  # The Overload
  sub { my $y = shift;
    (italic(grey("something is building in the orb")),
     italic(grey("it's too much. it's way too much.")),
     bold(yellow("CRACK. ZAP. the air smells like ozone.")),
     $y ? bold(green('"YOUR ANSWER IS YES AND IT ARRIVES WITH VOLTAGE"'))
        : bold(red('"NO. ALSO VOLTAGE."'))) },

  # The Unstable Prophet
  sub { my $y = shift;
    (italic(grey("the orb crackles")),
     italic(grey("it crackles more")),
     italic(grey("it crackles so much you start to question your life choices")),
     $y ? bold(green('"yES"')) : bold(red('"nO"')),
     $y ? bold(green('"sorry. still sparking. yES."')) : bold(red('"sorry. still sparking. nO."'))) },

  # The Power It Cannot Control
  sub { my $y = shift;
    (italic(grey("the orb didn't mean to do this")),
     italic(grey("the electricity just \x{2014} it just happens sometimes")),
     bold(yellow("ZAP")),
     $y ? bold(green('"The orb would like YES on the record."'))
        : bold(red('"The orb would like NO on the record."')),
     yellow('"It would also like to apologize for your eyebrows."')) },

  # The Ancient Machine
  sub { my $y = shift;
    (italic(grey("deep within the orb, something mechanical stirs")),
     italic(grey("gears that shouldn't exist. coils. voltage.")),
     bold(yellow("K\x{0335}\x{0336}R\x{0336}K\x{0336}K\x{0335}K\x{0336}")),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     yellow('"The machine has spoken. Do not tap the glass."')) },

  # The Reluctant Lightning
  sub { my $y = shift;
    (italic(grey("the orb is calm")),
     italic(grey("it is still calm")),
     italic(grey("it is \x{2014} ZZT \x{2014} still \x{2014} CRACK \x{2014} calm \x{2014}")),
     $y ? bold(green('"...YES."')) : bold(red('"...NO."')),
     italic(grey("the orb is calm again")),
     italic(grey("mostly"))) },

  # The Meltdown
  sub { my $y = shift;
    (bold(yellow("WARNING")),
     bold(yellow("WARNING")),
     italic(grey("crackling intensifies")),
     $y ? bold(green('"THE ANSWER IS YES"')) : bold(red('"THE ANSWER IS NO"')),
     bold(yellow('"THE ORB NEEDS A MOMENT"')),
     italic(grey("the crackling stops")),
     italic(grey("the orb smells like burnt toast"))) },

  # ═══ FIRE TIER — Ancient, Biblical Energy ════════════════════════════════

  # The Pyre
  sub { my $y = shift;
    (italic(grey("the orb begins to warm")),
     italic(grey("it gets warmer")),
     bold(darkYellow("it gets much warmer")),
     darkYellow('"Something burns in the orb that does not go out."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkYellow('"It has always been burning. You just couldn\'t see it before."')) },

  # The Consumed
  sub { my $y = shift;
    (bold(darkYellow("the orb ignites")),
     bold(darkYellow("it should not be doing this")),
     bold(darkYellow("it does not care")),
     darkYellow('"ASK AGAIN AND I WILL ASK THE FIRE."'),
     $y ? bold(green('"The fire says YES."')) : bold(red('"The fire says NO."')),
     darkYellow('"The fire is satisfied."')) },

  # The Offering
  sub { my $y = shift;
    (bold(darkYellow("the orb glows orange. then gold. then white.")),
     italic(grey("the heat reaches through the screen")),
     darkYellow('"Your question has been received."'),
     darkYellow('"Your question has been burned."'),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkYellow('"The smoke carries it to wherever answers go."')) },

  # The Old God
  sub { my $y = shift;
    (italic(grey("something ancient stirs in the orb")),
     italic(grey("it remembers when they built fires for it")),
     bold(darkYellow("it misses the fires")),
     $y ? bold(green('"YES."')) : bold(red('"NO."')),
     darkYellow('"The orb would appreciate a small fire in its honor."'),
     darkYellow('"This is not a joke."')) },

  # The Calm Inferno
  sub { my $y = shift;
    (bold(darkYellow("the orb is on fire")),
     bold(darkYellow("completely on fire")),
     bold(darkYellow("it seems fine with this")),
     $y ? bold(green('"Yes."')) : bold(red('"No."')),
     darkYellow('"The orb is fine."'),
     darkYellow('"The fire is fine."'),
     darkYellow('"Everything is fine."')) },

);

my $i = 0;
my $intermediates = 0;
my $unicode = 0;
while ($i <= $#ARGV) {
  if ($ARGV[$i] =~ /([0-9]*)d([0-9]+)/i) {
    $a = $1 if length($1) > 0;
    $x = $2;
    $intermediates = 1;
  } elsif ($ARGV[$i] eq "--dice") {
    $a = 2;
    $x = 6;
    $unicode = 1;
    $intermediates = 1;
  } elsif ($ARGV[$i] eq "--8ball") {
    @list = ("It is certain.",
      "It is decidedly so.",
      "Without a doubt.",
      "Yes - definitely.",
      "You may rely on it.",
      "As I see it, yes.",
      "Most likely.",
      "Outlook good.",
      "Yes.",
      "Signs point to yes.",
      "Reply hazy, try again.",
      "Ask again later.",
      "Better not tell you now.",
      "Cannot predict now.",
      "Concentrate and ask again.",
      "Don't count on it.",
      "My reply is no.",
      "My sources say no.",
      "Outlook not so good.",
      "Very doubtful.");
  } elsif ($ARGV[$i] eq "--orb") {
    if (int(rand(50)) == 0) {
      # 2% chance: legendary response
      my $is_yes = int(rand(2));
      my $resp = $orb_legendary[int(rand(scalar @orb_legendary))];
      print "$_\n" for $resp->($is_yes);
      exit 0;
    }
    # Standard 8-ball response
    @list = ("It is certain.",
      "It is decidedly so.",
      "Without a doubt.",
      "Yes - definitely.",
      "You may rely on it.",
      "As I see it, yes.",
      "Most likely.",
      "Outlook good.",
      "Yes.",
      "Signs point to yes.",
      "Reply hazy, try again.",
      "Ask again later.",
      "Better not tell you now.",
      "Cannot predict now.",
      "Concentrate and ask again.",
      "Don't count on it.",
      "My reply is no.",
      "My sources say no.",
      "Outlook not so good.",
      "Very doubtful.");
  } elsif ($ARGV[$i] eq "--card") {
    @list = @carddeck;
  } elsif ($ARGV[$i] eq "--coinflip") {
    @list = ("Heads", "Tails");
  } elsif ($ARGV[$i] eq "--roulette" or $ARGV[$i] eq "--wheel") {
    @list = @wheel;
  } elsif ($ARGV[$i] eq "--draw") {
    # allow per-user counts: e.g. --draw 5 user1 user2 7 user3
    $i++;
    my $n;
    my @draws;       # will hold arrayrefs [ user, count ]
    my $total = 0;

    while ($i <= $#ARGV) {
      if (isNumeric($ARGV[$i])) {
	$n = $ARGV[$i];
	if ($n <= 0) {
	  print "error: invalid number of cards to draw: $n\n";
	  exit 0;
	}
	$n = 52 if $n > 52;
      } else {
	if (not defined $n) {
	  print "error: must specify a count before users\n";
	  exit 0;
	}
	if (not ($ARGV[$i] ~~ @draws)) {  # don't draw more than once per user id
	  push @draws, [ $ARGV[$i], $n ]; # array ref
	  $total = $total + $n;
	  if ($total > 52) {
	    print "error: trying to draw more cards than are in the deck\n";
	    exit 0;
	  }
	}
      }
      $i++;
    }

    if (not @draws) {
      if (not defined $n) {
	print "error: no users given for draw\n";
	exit 0;
      } else {
	push @draws, [ "", $n ]; # array ref
      }
    }

    my $total = 0;
    foreach my $pair (@draws) {
      my ($user, $want) = @$pair;
      my $output = "";
      my $j = 0;

      while ($j < $want and $total < 52) {
	my $val = int rand(52);
	if (defined $carddeck[$val]) {
	  $output .= $carddeck[$val];
	  $output .= " " if $j < $want - 1;
	  $carddeck[$val] = undef;
	  $j++;
	  $total++;
	}
      }
      if (defined $user and $user ne "") {
	print "$user: $output\n";
      } else {
	print "$output\n";
      }
    }
    exit 0;
  } elsif (isNumeric($ARGV[$i])) {
    $a = 1;
    $x = $ARGV[$i];
  } else {
    push @list, $ARGV[$i];
  }
  $i++;
}

if ($#list > 0) {
  $a = 1;
  $x = $#list + 1;
}

#print "A=$a; X=$x\n";

if ($a > 1000) {
  print "ain't nobody got time for that.\n";
  exit 0;
}

my $hex = 0;
$hex = 1 if $x == 16;

my $sum = 0;

$i = 0;
while ($i < $a) {
  my $val = int(rand($x)) + 1;
  $sum += $val;
  print "[$val] " if $intermediates = 1 and $unicode == 0 and $a > 1 and $hex == 0;
  print chr(0x2680 + $val - 1), " " if $unicode == 1;
  print "0x" if $i == 0 and $hex == 1;
  printf "%X", ($val - 1) if $hex == 1;
  $i++;
}
print "= " if $intermediates = 1 and $a > 1 and $hex == 0;
print "$sum\n" if not $#list > 0 and $hex == 0;
print "\n" if $hex == 1;

if ($#list > 0) {
  print $list[$sum - 1], "\n";
}
